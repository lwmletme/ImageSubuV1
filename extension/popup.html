<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Auto Noise Images</title>
    <style>
      :root {
        --ani-ivory: #f7f2e7;
        --ani-black: #1a1a1a;
        --ani-ivory-soft: #fbf7ef;
        --ani-ivory-border: #e6ddcb;
      }

      body {
        margin: 0;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 14px;
        color: var(--ani-black);
        min-width: 220px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: linear-gradient(135deg, var(--ani-ivory), var(--ani-ivory-soft));
      }

      h1 {
        font-size: 16px;
        margin: 0;
        font-weight: 600;
        letter-spacing: 0.2px;
      }

      p {
        margin: 0;
        line-height: 1.5;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-weight: 500;
      }

      select,
      input[type='range'] {
        appearance: none;
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--ani-ivory-border);
        background: var(--ani-ivory);
        color: var(--ani-black);
        padding: 8px 10px;
        font-size: 13px;
      }

      input[type='range'] {
        padding: 0;
        height: 6px;
        background: var(--ani-ivory-border);
      }

      input[type='range']::-webkit-slider-thumb {
        appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--ani-black);
        cursor: pointer;
      }

      input[type='range']::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--ani-black);
        cursor: pointer;
      }

      .button-row {
        display: flex;
        gap: 8px;
      }

      button {
        padding: 10px 12px;
        border: none;
        border-radius: 8px;
        background: var(--ani-black);
        color: var(--ani-ivory);
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button.full-width {
        width: 100%;
      }

      button:active {
        transform: scale(0.97);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.25);
      }

      .status-message {
        font-size: 12px;
        color: var(--ani-black);
        opacity: 0.8;
        min-height: 16px;
      }

      .status-message.error {
        color: #a3302b;
      }

      .status-message.success {
        color: #1a672e;
      }
    </style>
  </head>
  <body>
    <h1>안녕하세요</h1>
    <p>이미지 노이즈 자동 적용 확장입니다.</p>
    <form id="noiseForm">
      <label>
        노이즈 방식
        <select id="noiseType" name="noiseType">
          <option value="uniform">Uniform</option>
          <option value="gaussian">Gaussian</option>
        </select>
      </label>
      <label>
        노이즈 강도: <span id="intensityLabel">20.0</span>
        <input
          id="intensity"
          name="intensity"
          type="range"
          min="0.5"
          max="100"
          step="0.5"
          value="20"
        />
      </label>
      <div class="button-row">
        <button type="button" id="startSelection">이미지 선택</button>
        <button type="button" id="clearSelection">선택 해제</button>
      </div>
      <button type="submit" class="full-width">선택 이미지에 노이즈 적용</button>
      <button type="button" id="downloadNoisy" class="full-width">노이즈 이미지 저장</button>
      <div class="status-message" id="statusMessage"></div>
    </form>
    <script>
      (() => {
        const DEFAULT_SETTINGS = Object.freeze({ noiseType: 'uniform', intensity: 20 });
        const form = document.getElementById('noiseForm');
        const noiseTypeSelect = document.getElementById('noiseType');
        const intensityInput = document.getElementById('intensity');
        const intensityLabel = document.getElementById('intensityLabel');
        const statusMessage = document.getElementById('statusMessage');
        const startSelectionButton = document.getElementById('startSelection');
        const clearSelectionButton = document.getElementById('clearSelection');
        const downloadButton = document.getElementById('downloadNoisy');

        const storageAvailable =
          typeof chrome !== 'undefined' && chrome.storage && chrome.storage.local;

        const clampIntensity = (value) => {
          const numeric = Number(value);
          if (Number.isNaN(numeric)) {
            return DEFAULT_SETTINGS.intensity;
          }
          return Math.min(Math.max(numeric, 0.5), 100);
        };

        const updateIntensityLabel = (value) => {
          intensityLabel.textContent = value.toFixed(1);
        };

        const setStatus = (message, tone = 'neutral') => {
          statusMessage.textContent = message;
          statusMessage.classList.remove('error', 'success');
          if (tone === 'error') {
            statusMessage.classList.add('error');
          } else if (tone === 'success') {
            statusMessage.classList.add('success');
          }
        };

        const applyFormValues = (settings) => {
          noiseTypeSelect.value = settings.noiseType;
          const intensityValue = clampIntensity(settings.intensity);
          intensityInput.value = intensityValue;
          updateIntensityLabel(intensityValue);
        };

        const sendMessageToActiveTab = (payload) =>
          new Promise((resolve, reject) => {
            if (typeof chrome === 'undefined' || !chrome.tabs) {
              reject(new Error('Chrome API를 사용할 수 없습니다.'));
              return;
            }

            chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
              const [tab] = tabs;
              if (!tab || typeof tab.id !== 'number') {
                reject(new Error('활성 탭을 찾을 수 없습니다.'));
                return;
              }

              chrome.tabs.sendMessage(tab.id, payload, (response) => {
                const lastError = chrome.runtime.lastError;
                if (lastError) {
                  reject(new Error(lastError.message));
                  return;
                }
                resolve(response);
              });
            });
          });

        const loadSettings = () => {
          if (!storageAvailable) {
            applyFormValues(DEFAULT_SETTINGS);
            setStatus('저장이 지원되지 않는 환경입니다.');
            return;
          }

          chrome.storage.local.get(DEFAULT_SETTINGS, (items) => {
            const settings = {
              noiseType:
                typeof items.noiseType === 'string' ? items.noiseType : DEFAULT_SETTINGS.noiseType,
              intensity: clampIntensity(items.intensity ?? DEFAULT_SETTINGS.intensity),
            };
            applyFormValues(settings);
          });
        };

        const refreshSelectionState = async () => {
          try {
            const response = await sendMessageToActiveTab({ type: 'ANI_GET_SELECTION_STATE' });
            if (!response) {
              return;
            }
            if (response.hasSelected) {
              setStatus('이미지가 선택되었습니다. 노이즈를 적용해 보세요.');
            }
          } catch (error) {
            // ignore; likely no content script on tab
          }
        };

        intensityInput.addEventListener('input', (event) => {
          const { value } = event.target;
          updateIntensityLabel(Number(parseFloat(value).toFixed(1)));
        });

        form.addEventListener('submit', (event) => {
          event.preventDefault();

          const payload = {
            noiseType: noiseTypeSelect.value,
            intensity: clampIntensity(intensityInput.value),
          };

          if (!storageAvailable) {
            setStatus('저장이 지원되지 않는 환경입니다.');
            return;
          }

          const afterSave = () => {
            setStatus('노이즈 설정을 적용했습니다.', 'success');
          };

          const applyToTab = async () => {
            try {
              await sendMessageToActiveTab({ type: 'ANI_APPLY_NOISE', payload });
              afterSave();
            } catch (error) {
              setStatus(error.message || '노이즈 적용 중 문제가 발생했습니다.', 'error');
            }
          };

          if (!storageAvailable) {
            applyToTab();
            return;
          }

          chrome.storage.local.set(payload, () => {
            applyToTab();
          });
        });

        startSelectionButton.addEventListener('click', async () => {
          try {
            await sendMessageToActiveTab({ type: 'ANI_START_SELECTION' });
            setStatus('선택할 이미지를 페이지에서 클릭하세요.');
          } catch (error) {
            setStatus(error.message || '이미지 선택 준비 중 오류가 발생했습니다.', 'error');
          }
        });

        clearSelectionButton.addEventListener('click', async () => {
          try {
            await sendMessageToActiveTab({ type: 'ANI_CLEAR_SELECTION' });
            setStatus('이미지 선택이 해제되었습니다.');
          } catch (error) {
            setStatus(error.message || '선택 해제에 실패했습니다.', 'error');
          }
        });

        downloadButton.addEventListener('click', async () => {
          try {
            const response = await sendMessageToActiveTab({
              type: 'ANI_GENERATE_NOISY_IMAGE',
              payload: {
                noiseType: noiseTypeSelect.value,
                intensity: clampIntensity(intensityInput.value),
              },
            });
            if (!response || !response.ok) {
              throw new Error(response?.error || '노이즈 이미지를 생성하지 못했습니다.');
            }

            const anchor = document.createElement('a');
            anchor.href = response.dataUrl;
            anchor.download = response.fileName || `noisy-image-${Date.now()}.png`;
            anchor.click();
            setStatus('노이즈 적용 이미지를 저장했습니다.', 'success');
          } catch (error) {
            setStatus(error.message || '이미지 저장 중 오류가 발생했습니다.', 'error');
          }
        });

        loadSettings();
        refreshSelectionState();

        if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.onMessage) {
          chrome.runtime.onMessage.addListener((message) => {
            if (!message || !message.type) {
              return;
            }

            if (message.type === 'ANI_SELECTION_CHANGED') {
              if (message.hasSelected) {
                setStatus('이미지가 선택되었습니다. 노이즈를 적용해 보세요.');
              } else {
                setStatus('이미지 선택이 해제되었습니다.');
              }
            }

            if (message.type === 'ANI_NOISE_APPLIED_FEEDBACK') {
              if (message.ok) {
                setStatus('노이즈가 적용되었습니다.', 'success');
              } else {
                setStatus(message.error || '노이즈 적용 중 문제가 발생했습니다.', 'error');
              }
            }
          });
        }
      })();
    </script>
  </body>
</html>
