<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Auto Noise Images</title>
    <style>
      :root {
        --ani-ivory: #f7f2e7;
        --ani-black: #1a1a1a;
        --ani-ivory-soft: #fbf7ef;
        --ani-ivory-border: #e6ddcb;
      }

      body {
        margin: 0;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 14px;
        color: var(--ani-black);
        min-width: 220px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: linear-gradient(135deg, var(--ani-ivory), var(--ani-ivory-soft));
      }

      h1 {
        font-size: 16px;
        margin: 0;
        font-weight: 600;
        letter-spacing: 0.2px;
      }

      p {
        margin: 0;
        line-height: 1.5;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-weight: 500;
      }

      select,
      input[type='range'] {
        appearance: none;
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--ani-ivory-border);
        background: var(--ani-ivory);
        color: var(--ani-black);
        padding: 8px 10px;
        font-size: 13px;
      }

      input[type='range'] {
        padding: 0;
        height: 6px;
        background: var(--ani-ivory-border);
      }

      input[type='range']::-webkit-slider-thumb {
        appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--ani-black);
        cursor: pointer;
      }

      input[type='range']::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--ani-black);
        cursor: pointer;
      }

      .button-group {
        display: flex;
        gap: 8px;
      }

      button {
        flex: 1;
        padding: 10px 12px;
        border: none;
        border-radius: 8px;
        background: var(--ani-black);
        color: var(--ani-ivory);
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button:active {
        transform: scale(0.97);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.25);
      }

      .status-message {
        font-size: 12px;
        color: var(--ani-black);
        opacity: 0.8;
        min-height: 16px;
      }
    </style>
  </head>
  <body>
    <h1>안녕하세요</h1>
    <p>이미지 노이즈 자동 적용 확장입니다.</p>
    <form id="noiseForm">
      <label>
        노이즈 방식
        <select id="noiseType" name="noiseType">
          <option value="uniform">Uniform</option>
          <option value="gaussian">Gaussian</option>
        </select>
      </label>
      <label>
        노이즈 강도: <span id="intensityLabel">20.0</span>
        <input
          id="intensity"
          name="intensity"
          type="range"
          min="0.5"
          max="100"
          step="0.5"
          value="20"
        />
      </label>
      <div class="button-group">
        <button type="submit">이미지 노이즈 생성</button>
        <button type="button" id="savePlaceholder">저장</button>
      </div>
      <div class="status-message" id="statusMessage"></div>
    </form>
    <script>
      (() => {
        const DEFAULT_SETTINGS = Object.freeze({ noiseType: 'uniform', intensity: 20 });
        const form = document.getElementById('noiseForm');
        const noiseTypeSelect = document.getElementById('noiseType');
        const intensityInput = document.getElementById('intensity');
        const intensityLabel = document.getElementById('intensityLabel');
        const statusMessage = document.getElementById('statusMessage');
        const savePlaceholderButton = document.getElementById('savePlaceholder');

        const storageAvailable =
          typeof chrome !== 'undefined' && chrome.storage && chrome.storage.local;

        const clampIntensity = (value) => {
          const numeric = Number(value);
          if (Number.isNaN(numeric)) {
            return DEFAULT_SETTINGS.intensity;
          }
          return Math.min(Math.max(numeric, 0.5), 100);
        };

        const updateIntensityLabel = (value) => {
          intensityLabel.textContent = value.toFixed(1);
        };

        const setStatus = (message) => {
          statusMessage.textContent = message;
        };

        const applyFormValues = (settings) => {
          noiseTypeSelect.value = settings.noiseType;
          const intensityValue = clampIntensity(settings.intensity);
          intensityInput.value = intensityValue;
          updateIntensityLabel(intensityValue);
        };

        const loadSettings = () => {
          if (!storageAvailable) {
            applyFormValues(DEFAULT_SETTINGS);
            setStatus('저장이 지원되지 않는 환경입니다.');
            return;
          }

          chrome.storage.local.get(DEFAULT_SETTINGS, (items) => {
            const settings = {
              noiseType:
                typeof items.noiseType === 'string' ? items.noiseType : DEFAULT_SETTINGS.noiseType,
              intensity: clampIntensity(items.intensity ?? DEFAULT_SETTINGS.intensity),
            };
            applyFormValues(settings);
          });
        };

        intensityInput.addEventListener('input', (event) => {
          const { value } = event.target;
          updateIntensityLabel(Number(parseFloat(value).toFixed(1)));
        });

        form.addEventListener('submit', (event) => {
          event.preventDefault();

          const payload = {
            noiseType: noiseTypeSelect.value,
            intensity: clampIntensity(intensityInput.value),
          };

          if (!storageAvailable) {
            setStatus('저장이 지원되지 않는 환경입니다.');
            return;
          }

          chrome.storage.local.set(payload, () => {
            setStatus('노이즈 설정이 업데이트되었습니다.');
          });
        });

        savePlaceholderButton.addEventListener('click', () => {
          setStatus('저장 기능은 추후에 지원될 예정입니다.');
        });

        loadSettings();
      })();
    </script>
  </body>
</html>
